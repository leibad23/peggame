<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peg Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .board {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .row {
            display: flex;
            justify-content: center;
            margin: 5px;
        }
        .peg {
            width: 40px;
            height: 40px;
            margin: 5px;
            border-radius: 50%;
            background-color: green;
            border: 2px solid black;
            cursor: pointer;
        }
        .empty {
            background-color: white;
            border: 2px solid black;
        }
        .selected {
            background-color: red !important;
        }

        #game_rules{
            color: red;
            padding: 10%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: larger;

        }
    </style>
</head>
<body>
    <h1>Peg Game</h1>
   <divid="game_rules">Board Size: You can specify the board size (greater than 2) to set up the game.
    Starting Position: Select a peg you want to remove as the starting position.
    Move Peg: Once the starting position is set, click on a peg to select it, then click on the empty space to move it.
    Winning Condition: The game checks for a win automatically after each move. If you win, it will display a congratulatory message. If no valid moves remain, the game ends.</div>div>
    <div id="remaining-moves"> </div>
    <h1 class="starting_peg">Select the Peg you would like to remove</h1>
    <div id="win-message" style="color: red; font-size: 20px;"></div>
    <input type="number" id="board-size" placeholder="Enter board size" min="3" style="margin-top: 20px; padding: 10px; font-size: 16px;" />
    
    <div class="board" id="game-board"></div>
    
    <button onclick="changeSize()" style="padding: 10px; font-size: 16px;">Set Size</button>
    <button onclick="resetGame()" style="margin-top: 20px; padding: 10px; font-size: 16px;">Reset Game</button>

    <script>
        let selectedPeg = null;
        let startingPositionSet = false;



        async function changeSize() {
        const size = document.getElementById("board-size").value;
        if (parseInt(size) < 3) {
            alert("Size must be greater than 2.");
            return;
        }

        const response = await fetch("/size", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ size: size })
        });

        const result = await response.json();
        if (result.status === "success") {
            fetchBoard();
            resetGame();
        } else {
            alert(result.message);
        }
    }




        async function fetchBoard() {
            const response = await fetch("/get_board" , {cache:"no-cache"});
            const data = await response.json();
            renderBoard(data.board);
            document.getElementById("remaining-moves").textContent = "Remaining Moves: " + data.remaining_moves;
        }

        async function resetGame() {
        const response = await fetch("/reset_game", {
            method: "POST"
        });

        if (response.ok) {
            document.getElementById("win-message").textContent = ""; // Clear win message
            startingPositionSet = false; // Reset game state
            fetchBoard(); // Reload board
        }
    }

        function renderBoard(board) {
            const boardContainer = document.getElementById("game-board");
            boardContainer.innerHTML = "";
            board.forEach((row, rowIndex) => {
                const rowDiv = document.createElement("div");
                rowDiv.classList.add("row");
                row.forEach((cell, colIndex) => {
                    const peg = document.createElement("div");
                    peg.classList.add("peg");
                    if (cell === 0) peg.classList.add("empty");
                    peg.dataset.row = rowIndex;
                    peg.dataset.col = colIndex;
                    peg.onclick = () => handlePegClick(peg);
                    rowDiv.appendChild(peg);
                });
                boardContainer.appendChild(rowDiv);
            });
        }

        function handlePegClick(peg) {
            const row = parseInt(peg.dataset.row);
            const col = parseInt(peg.dataset.col);

            if (!startingPositionSet) {
                
                setStartingPosition(row, col);
                const message = document.querySelector(".starting_peg").innerHTML= ""
                return;
            }

            if (!selectedPeg) {
                if (!peg.classList.contains("empty")) {
                    selectedPeg = peg;
                    peg.classList.add("selected");
                }
            } else {
                movePeg(selectedPeg, row, col);
                selectedPeg.classList.remove("selected");
                selectedPeg = null;
            }
        }

async function setStartingPosition(row, col) {
    const response = await fetch("/start_position", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ row, col })
    });

    const result = await response.json();
    if (response.ok) {
        startingPositionSet = true;
        fetchBoard(); // Reload the board
        if (result.win_message) {
            document.getElementById("win-message").textContent = result.win_message; // Show win message
        }
    } else {
        alert(result.message); // Show error if any
    }
}

        async function movePeg(selectedPeg, newRow, newCol) {
            const oldRow = parseInt(selectedPeg.dataset.row);
            const oldCol = parseInt(selectedPeg.dataset.col);

            const response = await fetch("/move_peg", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cR: oldRow, cC: oldCol, nR: newRow, nC: newCol })
            });

            const result = await response.json();
            if (result.status === "success") {
                fetchBoard();
                console.log(result.win_message)
                if (result.win_message) {
                    document.getElementById("win-message").textContent = result.win_message;
                }
            } else {
                alert(result.message);
            }
        }

        fetchBoard();
    </script>
</body>
</html>
